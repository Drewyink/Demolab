<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Benefits — Facets Mock</title>
  <link rel="stylesheet" href="/assets/styles.css" />
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="brand"><div class="logo"></div><div><h1>Enrollment Admin Manager</h1><p>Benefits</p></div></div>
      <nav class="nav">
        <a href="/index.html">Dashboard</a>
        <a href="/products.html">Products</a>
        <a href="/plans.html">Plans</a>
        <a class="active" href="/benefits.html">Benefits</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/claims.html">Claims</a>
        <a href="/audit.html">Audit</a>
      </nav>
      <div class="footer-note">Training simulator. Not TriZetto/Facets.</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2>Benefit Rules (Add / Edit)</h2>
        <span class="badge">DB: SQLite</span>
      </div>

      <div class="grid">
        <section class="card">
          <h3>New / Edit Rule</h3>
          <div class="notice">Tip: Use CPT range 99200–99299 for office, REV 100–199 for inpatient.</div>
          <div class="form" id="form">
            <div class="full">
              <label>Plan</label>
              <select id="plan"></select>
            </div>
            <div>
              <label>Tier</label>
              <select id="tier"><option value="INN">INN</option><option value="OON">OON</option></select>
            </div>
            <div>
              <label>Service Category</label>
              <input id="svc" value="Primary Care Visit" />
            </div>

            <div>
              <label>Code Type</label>
              <select id="ctype"><option value="CPT">CPT</option><option value="REV">REV</option></select>
            </div>
            <div>
              <label>Code Start</label>
              <input id="cs" value="99213" />
            </div>
            <div>
              <label>Code End</label>
              <input id="ce" value="99213" />
            </div>

            <div>
              <label>Covered</label>
              <select id="covered"><option value="1" selected>Yes</option><option value="0">No</option></select>
            </div>
            <div>
              <label>Deductible Applies</label>
              <select id="ded"><option value="1">Yes</option><option value="0" selected>No</option></select>
            </div>

            <div>
              <label>Copay ($)</label>
              <input id="copay" value="25" />
            </div>
            <div>
              <label>Coins % (Member)</label>
              <input id="coins" value="0" />
            </div>

            <div>
              <label>Accumulator Applied</label>
              <select id="accap">
                <option value="Both">Both</option>
                <option value="DED">DED</option>
                <option value="OOP" selected>OOP</option>
                <option value="None">None</option>
              </select>
            </div>
            <div>
              <label>Auth Required</label>
              <select id="auth"><option value="0" selected>No</option><option value="1">Yes</option></select>
            </div>

            <div>
              <label>Effective</label>
              <input id="eff" type="date" value="2026-01-01" />
            </div>
            <div>
              <label>Term</label>
              <input id="term" type="date" value="2026-12-31" />
            </div>

            <div class="full">
              <label>Notes</label>
              <input id="notes" value="Copay before deductible" />
            </div>

            <div class="full">
              <input type="hidden" id="benefit_id" />
              <button class="btn primary" id="saveBtn">Save Rule</button>
              <button class="btn" id="clearBtn" type="button">Clear</button>
              <div id="msg" class="footer-note"></div>
            </div>
          </div>
        </section>

        <section class="card">
          <h3>Rules</h3>
          <div class="form" style="grid-template-columns:1fr 1fr">
            <div>
              <label>Filter Plan</label>
              <select id="filterPlan"></select>
            </div>
            <div>
              <label>Filter Tier</label>
              <select id="filterTier">
                <option value="">All</option>
                <option value="INN">INN</option>
                <option value="OON">OON</option>
              </select>
            </div>
          </div>
          <table class="table" id="tbl">
            <thead>
              <tr>
                <th>Tier</th><th>Service</th><th>Code</th><th>Ded</th><th>Copay</th><th>Coins</th><th>Auth</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const esc = (s)=>String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    async function api(path, opts={}){
      const res = await fetch("/api"+path,{ headers:{ "Content-Type":"application/json" }, ...opts });
      const txt = await res.text();
      let data=null; try{ data=txt?JSON.parse(txt):null; }catch{ data={ raw:txt }; }
      if(!res.ok) throw new Error(data?.error || res.statusText);
      return data;
    }

    async function loadPlans(){
      const plans = await api("/plans");
      const options = plans.map(p=>`<option value="${esc(p.plan_id)}">${esc(p.plan_id)} — ${esc(p.plan_name)}</option>`).join("");
      $("#plan").innerHTML = options;
      $("#filterPlan").innerHTML = options;
    }

    async function loadRules(){
      const plan_id = $("#filterPlan").value;
      const tier = $("#filterTier").value;
      const q = `/benefits?plan_id=${encodeURIComponent(plan_id)}${tier ? `&tier=${encodeURIComponent(tier)}` : ""}`;
      const rows = await api(q);

      $("#tbl tbody").innerHTML = rows.map(r=>`
        <tr>
          <td><b>${esc(r.tier)}</b></td>
          <td>${esc(r.service_category)}</td>
          <td class="mono">${esc(r.code_type)} ${esc(r.code_start)}-${esc(r.code_end)}</td>
          <td>${r.deductible_applies ? "Y" : "N"}</td>
          <td>$${Number(r.copay||0).toFixed(2)}</td>
          <td>${Number(r.coins_pct||0).toFixed(0)}%</td>
          <td>${r.auth_required ? "Y" : "N"}</td>
          <td><button class="btn small" data-edit="${esc(r.benefit_id)}">Edit</button></td>
        </tr>
      `).join("") || `<tr><td colspan="8" class="footer-note">No rules</td></tr>`;
    }

    async function editRule(id){
      const rows = await api(`/benefits?plan_id=${encodeURIComponent($("#filterPlan").value)}`);
      const r = rows.find(x=>x.benefit_id===id);
      if(!r) return;

      $("#benefit_id").value = r.benefit_id;
      $("#plan").value = r.plan_id;
      $("#tier").value = r.tier;
      $("#svc").value = r.service_category;
      $("#ctype").value = r.code_type;
      $("#cs").value = r.code_start;
      $("#ce").value = r.code_end;
      $("#covered").value = r.covered;
      $("#ded").value = r.deductible_applies;
      $("#copay").value = r.copay;
      $("#coins").value = r.coins_pct;
      $("#accap").value = r.accumulator_applied;
      $("#auth").value = r.auth_required;
      $("#eff").value = r.effective_date;
      $("#term").value = r.term_date;
      $("#notes").value = r.notes || "";
      $("#msg").textContent = "Loaded for edit ✅";
    }

    function clearForm(){
      $("#benefit_id").value = "";
      $("#svc").value = "";
      $("#cs").value = "";
      $("#ce").value = "";
      $("#notes").value = "";
      $("#msg").textContent = "";
    }

    $("#saveBtn").addEventListener("click", async (e)=>{
      e.preventDefault();
      $("#msg").textContent = "Saving...";
      const payload = {
        benefit_id: $("#benefit_id").value || undefined,
        plan_id: $("#plan").value,
        tier: $("#tier").value,
        service_category: $("#svc").value.trim(),
        code_type: $("#ctype").value,
        code_start: Number($("#cs").value),
        code_end: Number($("#ce").value),
        covered: Number($("#covered").value),
        deductible_applies: Number($("#ded").value),
        copay: Number($("#copay").value),
        coins_pct: Number($("#coins").value),
        accumulator_applied: $("#accap").value,
        auth_required: Number($("#auth").value),
        notes: $("#notes").value.trim(),
        effective_date: $("#eff").value,
        term_date: $("#term").value
      };

      try{
        if (payload.benefit_id){
          await api(`/benefits/${encodeURIComponent(payload.benefit_id)}`, { method:"PUT", body: JSON.stringify(payload) });
        } else {
          await api("/benefits", { method:"POST", body: JSON.stringify(payload) });
        }
        $("#msg").textContent = "Saved ✅";
        await loadRules();
        clearForm();
      }catch(err){
        $("#msg").textContent = "Error: " + err.message;
      }
    });

    $("#clearBtn").addEventListener("click", clearForm);

    $("#tbl").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-edit]");
      if(!btn) return;
      editRule(btn.dataset.edit).catch(err=>$("#msg").textContent="Error: "+err.message);
    });

    $("#filterPlan").addEventListener("change", ()=>loadRules().catch(()=>{}));
    $("#filterTier").addEventListener("change", ()=>loadRules().catch(()=>{}));

    (async()=>{ await loadPlans(); await loadRules(); })().catch(err=>$("#msg").textContent="Error: "+err.message);
  </script>
</body>
</html>
