<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Claims — Facets Mock</title>
  <link rel="stylesheet" href="/assets/styles.css" />
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="brand"><div class="logo"></div><div><h1>Enrollment Admin Manager</h1><p>Claims</p></div></div>
      <nav class="nav">
        <a href="/index.html">Dashboard</a>
        <a href="/products.html">Products</a>
        <a href="/plans.html">Plans</a>
        <a href="/benefits.html">Benefits</a>
        <a href="/pricing.html">Pricing</a>
        <a class="active" href="/claims.html">Claims</a>
        <a href="/audit.html">Audit</a>
      </nav>
      <div class="footer-note">Training simulator. Not TriZetto/Facets.</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2>Claim Simulator</h2>
        <span class="badge">DB: SQLite</span>
      </div>

      <div class="grid">
        <section class="card">
          <h3>Submit Claim</h3>
          <div class="form">
            <div class="full">
              <label>Member</label>
              <select id="member"></select>
            </div>
            <div>
              <label>DOS</label>
              <input id="dos" type="date" value="2026-02-10" />
            </div>
            <div>
              <label>Provider</label>
              <input id="prov" value="City Hospital" />
            </div>
            <div>
              <label>Tier</label>
              <select id="tier"><option value="INN">INN</option><option value="OON">OON</option></select>
            </div>
            <div>
              <label>Code Type</label>
              <select id="ctype"><option value="CPT">CPT</option><option value="REV">REV</option></select>
            </div>
            <div>
              <label>Code</label>
              <input id="code" value="99213" />
            </div>
            <div>
              <label>Billed Amount</label>
              <input id="billed" value="150" />
            </div>
            <div class="full">
              <button class="btn primary" id="run">Adjudicate</button>
              <div id="msg" class="footer-note"></div>
            </div>
          </div>

          <div class="notice" style="margin-top:12px">
            <div class="mono"><b>Try</b> CPT 99213, CPT 99395, CPT 99285, REV 110, CPT 71020, CPT 70551</div>
          </div>
        </section>

        <section class="card">
          <h3>Result</h3>
          <div id="result" class="notice">No claim submitted yet.</div>
        </section>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Result Trace (Audit)</h3>
        <table class="table" id="auditTbl">
          <thead><tr><th>Step</th><th>Detail</th></tr></thead>
          <tbody><tr><td colspan="2" class="footer-note">No audit yet</td></tr></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const esc = (s)=>String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    async function api(path, opts={}){
      const res = await fetch("/api"+path,{ headers:{ "Content-Type":"application/json" }, ...opts });
      const txt = await res.text();
      let data=null; try{ data=txt?JSON.parse(txt):null; }catch{ data={ raw:txt }; }
      if(!res.ok) throw new Error(data?.error || res.statusText);
      return data;
    }
    const money = (n)=>`$${Number(n||0).toFixed(2)}`;

    async function loadMembers(){
      const members = await api("/members");
      $("#member").innerHTML = members.map(m=>`<option value="${esc(m.member_id)}">${esc(m.last_name)}, ${esc(m.first_name)} (${esc(m.member_id)})</option>`).join("");
    }

    $("#run").addEventListener("click", async ()=>{
      $("#msg").textContent="Running...";
      $("#result").textContent="Processing...";
      try{
        const r = await api("/claims/adjudicate",{
          method:"POST",
          body: JSON.stringify({
            member_id: $("#member").value,
            dos: $("#dos").value,
            provider_name: $("#prov").value.trim(),
            tier: $("#tier").value,
            code_type: $("#ctype").value,
            code: Number($("#code").value),
            billed_amount: Number($("#billed").value)
          })
        });

        const rr = r.result;
        $("#result").innerHTML = `
          <b>Status:</b> ${esc(rr.status)}<br/>
          <b>Allowed:</b> ${money(rr.allowed_amount)}<br/>
          <b>Member:</b> ${money(rr.member)} (Copay ${money(rr.copay_applied)} | Ded ${money(rr.deductible_applied)} | Coins ${money(rr.coins_applied)})<br/>
          <b>Plan:</b> ${money(rr.plan)}<br/>
          <div class="footer-note mono">Claim ID: ${esc(r.claim_id)}</div>
        `;

        const auditRows = (r.audit||[]).map(a=>`
          <tr><td><b>${esc(a.step)}</b></td><td>${esc(a.detail)}</td></tr>
        `).join("") || `<tr><td colspan="2" class="footer-note">No audit</td></tr>`;
        $("#auditTbl tbody").innerHTML = auditRows;

        $("#msg").textContent="Done ✅";
      }catch(e){
        $("#msg").textContent="Error: "+e.message;
        $("#result").textContent="Error: "+e.message;
      }
    });

    loadMembers().catch(e=>$("#msg").textContent="Error: "+e.message);
  </script>
</body>
</html>
