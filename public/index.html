<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facets Mock Sandbox — Dashboard</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Enrollment Admin Manager</h1>
          <p>Dashboard</p>
        </div>
      </div>

      <nav class="nav">
        <a class="active" href="/index.html">Dashboard</a>
        <a href="/products.html">Products</a>
        <a href="/plans.html">Plans</a>
        <a href="/benefits.html">Benefits</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/members.html">Members</a>
        <a href="/claims.html">Claims</a>
        <a href="/audit.html">Audit</a>
      </nav>

      <div class="footer-note">Training simulator. Not TriZetto/Facets.</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2>Facets Mock Sandbox</h2>
        <span class="badge" id="env">Loading…</span>
      </div>

      <div class="grid" style="margin-top:14px">
        <section class="card">
          <h3>Plan Summary</h3>
          <div id="summary" class="notice">Loading summary…</div>
        </section>

        <section class="card">
          <h3>Quick Actions</h3>
          <div class="form" style="grid-template-columns:1fr">
            <a class="btn primary" href="/claims.html">Run Claim Simulator</a>
            <a class="btn" href="/members.html">Search Members</a>
            <a class="btn" href="/benefits.html">Edit Benefit Rules</a>
            <a class="btn" href="/pricing.html">Edit Fee Schedule</a>
          </div>
          <div class="footer-note">Tip: Start with Benefits + Pricing, then run Claims.</div>
        </section>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>System Counts</h3>
        <table class="table">
          <thead>
            <tr><th>Entity</th><th>Count</th></tr>
          </thead>
          <tbody id="counts">
            <tr><td colspan="2" class="footer-note">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    const esc = (s)=>String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    async function api(path){
      const res = await fetch("/api" + path);
      const txt = await res.text();
      let data=null; try{ data = txt ? JSON.parse(txt) : null; } catch { data = { raw: txt }; }
      if(!res.ok) throw new Error(data?.error || res.statusText);
      return data;
    }

    function kvBlock(title, obj){
      return `
        <div class="kv">
          ${Object.entries(obj).map(([k,v]) => `
            <div>${esc(k)}</div><div class="${k.toLowerCase().includes('id') ? 'mono' : ''}">${esc(v)}</div>
          `).join("")}
        </div>
      `;
    }

    (async()=>{
      const s = await api("/summary");
      document.getElementById("env").textContent = "SQLite Connected ✅";

      const product = s.product || {};
      const plan = s.plan || {};

      document.getElementById("summary").innerHTML = `
        ${kvBlock("Product", {
          "Carrier": product.carrier || "EchoHealth (mock)",
          "LOB": product.lob || "-",
          "Product ID": product.product_id || "-",
          "Product Name": product.product_name || "-",
          "Effective": product.effective_date || "-",
          "Term": product.term_date || "-"
        })}
        <hr/>
        ${kvBlock("Plan", {
          "Plan ID": plan.plan_id || "-",
          "Plan Name": plan.plan_name || "-",
          "Network Model": plan.network_model || "-",
          "Effective": plan.effective_date || "-",
          "Term": plan.term_date || "-",
          "Notes": plan.notes || "-"
        })}
      `;

      document.getElementById("counts").innerHTML = `
        <tr><td>Benefit Rules</td><td class="mono">${esc(s.ruleCount)}</td></tr>
        <tr><td>Claims</td><td class="mono">${esc(s.claimCount)}</td></tr>
      `;
    })().catch(err=>{
      document.getElementById("env").textContent = "API Error";
      document.getElementById("summary").textContent = "Error: " + err.message;
      document.getElementById("counts").innerHTML = `<tr><td colspan="2">Error: ${esc(err.message)}</td></tr>`;
    });
  </script>
</body>
</html>
