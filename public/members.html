<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Members ‚Äî Facets Sandbox</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-text">FACETS</div>
      <div class="logo-env">Sandbox</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Configuration</div>
      <a class="nav-item" data-page="members" href="/members"><span class="nav-icon">üë§</span> Members</a>
      <a class="nav-item" data-page="products" href="/products"><span class="nav-icon">üì¶</span> Products</a>
      <a class="nav-item" data-page="plans" href="/plans"><span class="nav-icon">üìã</span> Plans</a>
      <a class="nav-item" data-page="benefits" href="/benefits"><span class="nav-icon">üõ°Ô∏è</span> Benefits</a>
      <a class="nav-item" data-page="pricing" href="/pricing"><span class="nav-icon">üí≤</span> Pricing</a>
      <div class="nav-section-label">Operations</div>
      <a class="nav-item" data-page="claims" href="/claims"><span class="nav-icon">üìÑ</span> Claims</a>
      <div class="nav-section-label">System</div>
      <a class="nav-item" data-page="audit" href="/audit"><span class="nav-icon">üîç</span> Audit Log</a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">??</div>
        <div>
          <div class="user-name" id="user-name">Loading...</div>
          <div class="user-role" id="user-role"></div>
        </div>
      </div>
      <button class="btn-logout" id="btn-logout">Sign Out</button>
    </div>
  </aside>

  <div class="main-content">
    <div class="top-bar">
      <div>
        <div class="page-title">Members</div>
        <div class="page-subtitle">Enrollment & eligibility management</div>
      </div>
      <div class="top-bar-actions">
        <button class="btn btn-secondary btn-sm" id="btn-export">‚¨á Export</button>
        <button class="btn btn-primary btn-sm" id="btn-new">+ New Member</button>
      </div>
    </div>
    <div class="page-content">
      <div class="card" style="margin-bottom:20px">
        <div class="card-body" style="padding:14px 20px">
          <div class="filters-row">
            <div class="search-bar">
              <span class="search-icon">üîç</span>
              <input type="text" id="search" placeholder="Search name, email, ID...">
            </div>
            <select id="filter-status">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
            <select id="filter-plan">
              <option value="">All Plans</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Member Directory</div>
          <div id="member-count" style="font-size:12px;color:var(--gray-400);font-family:var(--font-mono)">Loading...</div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Member ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Plan</th>
                <th>Employer</th>
                <th>Effective</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="members-tbody">
              <tr><td colspan="8" class="table-empty"><div class="loading"><div class="spinner"></div> Loading members...</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination">
          <div class="pagination-info" id="pagination-info"></div>
          <div class="pagination-btns" id="pagination-btns"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay hidden" id="modal-detail">
  <div class="modal modal-lg">
    <div class="modal-header">
      <span class="modal-title" id="detail-title">Member Detail</span>
      <button class="modal-close" onclick="closeModal('modal-detail')">‚úï</button>
    </div>
    <div class="modal-body" id="detail-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-detail')">Close</button>
      <button class="btn btn-primary" id="btn-detail-edit">Edit Member</button>
    </div>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="modal-overlay hidden" id="modal-form">
  <div class="modal modal-lg">
    <div class="modal-header">
      <span class="modal-title" id="form-title">Add Member</span>
      <button class="modal-close" onclick="closeModal('modal-form')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="form-error" class="alert alert-error hidden"></div>
      <form id="member-form">
        <div class="form-row">
          <div class="form-group"><label>First Name *</label><input name="first_name" required></div>
          <div class="form-group"><label>Last Name *</label><input name="last_name" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Email</label><input name="email" type="email"></div>
          <div class="form-group"><label>Phone</label><input name="phone" placeholder="555-000-0000"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Date of Birth</label><input name="date_of_birth" type="date"></div>
          <div class="form-group"><label>Gender</label>
            <select name="gender">
              <option value="">Select</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="non-binary">Non-binary</option>
              <option value="prefer_not_to_say">Prefer not to say</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Address</label><input name="address" placeholder="Street address"></div>
        <div class="form-row-3">
          <div class="form-group"><label>City</label><input name="city"></div>
          <div class="form-group"><label>State</label><input name="state" maxlength="2" placeholder="CA"></div>
          <div class="form-group"><label>ZIP</label><input name="zip" maxlength="10"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Plan</label>
            <select name="plan_id" id="form-plan-select"><option value="">Select Plan</option></select>
          </div>
          <div class="form-group"><label>Employer</label><input name="employer"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Effective Date</label><input name="effective_date" type="date"></div>
          <div class="form-group"><label>Termination Date</label><input name="termination_date" type="date"></div>
        </div>
        <div class="form-group">
          <div class="form-check">
            <input type="checkbox" name="is_active" id="is-active" checked>
            <label for="is-active">Active Member</label>
          </div>
        </div>
        <input type="hidden" name="id">
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-form')">Cancel</button>
      <button class="btn btn-primary" id="btn-save">Save Member</button>
    </div>
  </div>
</div>

<script src="/app.js"></script>
<script>
if (!requireAuth()) throw new Error('redirect');

let allMembers = [];
let currentPage = 1;
const paginator = new Paginator({
  container: document.getElementById('pagination-btns'),
  infoEl: document.getElementById('pagination-info'),
  onPage: p => { currentPage = p; loadMembers(); }
});

async function loadPlans() {
  try {
    const plans = await Auth.get('/api/plans');
    const sel1 = document.getElementById('filter-plan');
    const sel2 = document.getElementById('form-plan-select');
    plans.forEach(p => {
      sel1.innerHTML += `<option value="${p.id}">${p.name}</option>`;
      sel2.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
  } catch(e) {}
}

async function loadMembers() {
  const search = document.getElementById('search').value;
  const status = document.getElementById('filter-status').value;
  const planId = document.getElementById('filter-plan').value;
  let qs = `?page=${currentPage}&limit=20`;
  if (search) qs += `&search=${encodeURIComponent(search)}`;
  if (status) qs += `&status=${status}`;
  if (planId) qs += `&plan_id=${planId}`;
  const tbody = document.getElementById('members-tbody');
  tbody.innerHTML = `<tr><td colspan="8" class="table-empty"><div class="loading"><div class="spinner"></div> Loading...</div></td></tr>`;
  try {
    const data = await Auth.get(`/api/members${qs}`);
    allMembers = data.data;
    document.getElementById('member-count').textContent = `${data.total} members`;
    paginator.update(data.total, data.page);
    if (!data.data.length) { tbody.innerHTML = `<tr><td colspan="8" class="table-empty">No members found</td></tr>`; return; }
    tbody.innerHTML = data.data.map(m => `
      <tr>
        <td><span class="mono" style="color:var(--cyan-400)">${m.member_id}</span></td>
        <td><strong>${m.first_name} ${m.last_name}</strong></td>
        <td style="color:var(--gray-300)">${m.email || '‚Äî'}</td>
        <td>${m.plan_name ? `<span style="font-size:12px">${m.plan_name}</span>` : '‚Äî'}</td>
        <td style="color:var(--gray-300)">${m.employer || '‚Äî'}</td>
        <td style="font-family:var(--font-mono);font-size:12px">${fmtDate(m.effective_date)}</td>
        <td>${badge(m.is_active ? 'Active' : 'Inactive', m.is_active ? 'active' : 'inactive')}</td>
        <td>
          <div style="display:flex;gap:4px">
            <button class="btn btn-secondary btn-sm" onclick="viewMember('${m.id}')">View</button>
            <button class="btn btn-secondary btn-sm" onclick="editMember('${m.id}')">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deactivateMember('${m.id}','${m.first_name} ${m.last_name}')">Remove</button>
          </div>
        </td>
      </tr>`).join('');
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="8" class="table-empty">Error: ${e.message}</td></tr>`;
  }
}

async function viewMember(id) {
  const m = allMembers.find(x => x.id === id);
  if (!m) return;
  document.getElementById('detail-title').textContent = `${m.first_name} ${m.last_name}`;
  document.getElementById('detail-body').innerHTML = `
    <div class="detail-grid" style="margin-bottom:20px">
      <div class="detail-item"><div class="detail-label">Member ID</div><div class="detail-value mono">${m.member_id}</div></div>
      <div class="detail-item"><div class="detail-label">Status</div><div class="detail-value">${badge(m.is_active?'Active':'Inactive',m.is_active?'active':'inactive')}</div></div>
      <div class="detail-item"><div class="detail-label">Email</div><div class="detail-value">${m.email||'‚Äî'}</div></div>
      <div class="detail-item"><div class="detail-label">Phone</div><div class="detail-value">${m.phone||'‚Äî'}</div></div>
      <div class="detail-item"><div class="detail-label">Date of Birth</div><div class="detail-value">${fmtDate(m.date_of_birth)}</div></div>
      <div class="detail-item"><div class="detail-label">Gender</div><div class="detail-value" style="text-transform:capitalize">${m.gender||'‚Äî'}</div></div>
      <div class="detail-item"><div class="detail-label">Address</div><div class="detail-value">${[m.address,m.city,m.state,m.zip].filter(Boolean).join(', ')||'‚Äî'}</div></div>
      <div class="detail-item"><div class="detail-label">Employer</div><div class="detail-value">${m.employer||'‚Äî'}</div></div>
      <div class="detail-item"><div class="detail-label">Plan</div><div class="detail-value">${m.plan_name||'‚Äî'}</div></div>
      <div class="detail-item"><div class="detail-label">Effective Date</div><div class="detail-value">${fmtDate(m.effective_date)}</div></div>
    </div>`;
  document.getElementById('btn-detail-edit').onclick = () => { closeModal('modal-detail'); editMember(id); };
  openModal('modal-detail');
}

function editMember(id) {
  const m = allMembers.find(x => x.id === id);
  if (!m) return;
  document.getElementById('form-title').textContent = 'Edit Member';
  const form = document.getElementById('member-form');
  Object.keys(m).forEach(k => {
    const el = form.elements[k];
    if (!el) return;
    if (el.type === 'checkbox') el.checked = m[k];
    else el.value = m[k] != null ? (k.includes('date') && m[k] ? m[k].slice(0,10) : m[k]) : '';
  });
  document.getElementById('form-error').classList.add('hidden');
  openModal('modal-form');
}

document.getElementById('btn-new').onclick = () => {
  document.getElementById('form-title').textContent = 'Add Member';
  document.getElementById('member-form').reset();
  document.getElementById('is-active').checked = true;
  document.getElementById('member-form').elements['id'].value = '';
  document.getElementById('form-error').classList.add('hidden');
  openModal('modal-form');
};

document.getElementById('btn-save').onclick = async () => {
  const form = document.getElementById('member-form');
  const data = {};
  new FormData(form).forEach((v,k) => data[k] = v);
  data.is_active = document.getElementById('is-active').checked;
  const id = data.id; delete data.id;
  const btn = document.getElementById('btn-save');
  btn.textContent = 'Saving...'; btn.disabled = true;
  const errEl = document.getElementById('form-error');
  try {
    if (id) await Auth.put(`/api/members/${id}`, data);
    else await Auth.post('/api/members', data);
    closeModal('modal-form');
    toast(id ? 'Member updated' : 'Member created', 'success');
    loadMembers();
  } catch(e) { errEl.textContent = e.message; errEl.classList.remove('hidden'); }
  finally { btn.textContent = 'Save Member'; btn.disabled = false; }
};

async function deactivateMember(id, name) {
  const ok = await confirm(`Deactivate member <strong>${name}</strong>?`);
  if (!ok) return;
  try { await Auth.delete(`/api/members/${id}`); toast('Member deactivated','success'); loadMembers(); }
  catch(e) { toast(e.message,'error'); }
}

document.getElementById('btn-export').onclick = () => exportCSV(allMembers, 'members.csv');
let searchTimeout;
document.getElementById('search').oninput = () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentPage=1; loadMembers(); }, 350); };
document.getElementById('filter-status').onchange = () => { currentPage=1; loadMembers(); };
document.getElementById('filter-plan').onchange = () => { currentPage=1; loadMembers(); };

loadPlans();
loadMembers();
</script>
</body>
</html>
