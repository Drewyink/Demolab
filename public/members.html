<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facets â€” Members</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">FX</div>
      <div><div class="logo-text">FACETS</div><div class="logo-sub">Config Suite</div></div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Overview</div>
      <a class="nav-item" href="index.html"><span class="nav-icon">â—ˆ</span> Dashboard</a>
      <div class="nav-section-label">Configuration</div>
      <a class="nav-item" href="members.html"><span class="nav-icon">ğŸ‘¤</span> Members</a>
      <a class="nav-item" href="products.html"><span class="nav-icon">ğŸ“¦</span> Products</a>
      <a class="nav-item" href="plans.html"><span class="nav-icon">ğŸ“‹</span> Plans</a>
      <a class="nav-item" href="benefits.html"><span class="nav-icon">âœš</span> Benefits</a>
      <a class="nav-item" href="pricing.html"><span class="nav-icon">ğŸ’²</span> Pricing</a>
      <div class="nav-section-label">Operations</div>
      <a class="nav-item" href="claims.html"><span class="nav-icon">ğŸ“„</span> Claims</a>
      <a class="nav-item" href="audit.html"><span class="nav-icon">ğŸ”</span> Audit Log</a>
    </nav>
    <div class="sidebar-footer"><div class="env-badge">Sandbox Â· v1.0</div></div>
  </aside>
  <main class="main-content">
    <div class="topbar">
      <div class="topbar-left"><span class="topbar-breadcrumb">Configuration â†’ <span>Members</span></span></div>
      <div class="topbar-right">
        <span id="api-status" style="font-size:11px;font-family:'IBM Plex Mono',monospace;margin-right:12px"></span>
        <span class="topbar-clock" id="clock"></span>
      </div>
    </div>
    <div class="page-content">
      <div class="page-header">
        <div>
          <div class="page-title">Member Management</div>
          <div class="page-subtitle">ENROLL Â· MANAGE Â· TERMINATE</div>
        </div>
        <button class="btn btn-primary" onclick="openModal()">+ New Member</button>
      </div>

      <!-- API ERROR BANNER -->
      <div id="api-error-banner" style="display:none;background:rgba(255,71,87,0.1);border:1px solid rgba(255,71,87,0.4);border-radius:8px;padding:14px 18px;margin-bottom:16px;color:#ff4757;font-size:13px;">
        <strong>âš  API Error:</strong> <span id="api-error-text"></span>
        <br><small style="color:var(--text3);margin-top:4px;display:block">Check Render Logs â†’ your service â†’ Logs tab for details.</small>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ‘¤ Members <span class="count-label" id="count"></span></span>
          <div class="toolbar-left">
            <div class="search-bar" style="margin:0;flex:1;min-width:220px">
              <span class="search-icon">ğŸ”</span>
              <input type="text" placeholder="Search members..." id="search-input">
            </div>
            <div class="filter-tabs">
              <button class="filter-tab active" onclick="filterStatus('all', this)">All</button>
              <button class="filter-tab" onclick="filterStatus('active', this)">Active</button>
              <button class="filter-tab" onclick="filterStatus('inactive', this)">Inactive</button>
            </div>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead><tr>
              <th>Member ID</th><th>Name</th><th>DOB</th><th>Email</th><th>Phone</th><th>Status</th><th>Enrolled</th><th>Actions</th>
            </tr></thead>
            <tbody id="members-tbody">
              <tr><td colspan="8"><div class="empty-state"><div class="empty-icon">ğŸ‘¤</div><p>Loading members...</p></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modal-title">New Member</span>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- SAVE ERROR DISPLAY -->
      <div id="save-error" style="display:none;background:rgba(255,71,87,0.1);border:1px solid rgba(255,71,87,0.4);border-radius:6px;padding:10px 14px;margin-bottom:16px;color:#ff4757;font-size:12px;"></div>

      <form id="member-form" class="form-grid">
        <input type="hidden" id="f-id">
        <div class="form-group">
          <label class="form-label">Member ID *</label>
          <input type="text" class="form-input" id="f-member_id" placeholder="MBR-001" required>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="f-status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="terminated">Terminated</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">First Name *</label>
          <input type="text" class="form-input" id="f-first_name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Last Name *</label>
          <input type="text" class="form-input" id="f-last_name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Date of Birth</label>
          <input type="date" class="form-input" id="f-dob">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="text" class="form-input" id="f-phone" placeholder="555-0100">
        </div>
        <div class="form-group full">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="f-email">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveMember()">Save Member</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
<script>
let members = [];
let statusFilter = 'all';

async function loadMembers() {
  const tbody = document.getElementById('members-tbody');
  const banner = document.getElementById('api-error-banner');
  const statusEl = document.getElementById('api-status');

  try {
    const res = await fetch('/api/members');
    if (!res.ok) {
      const errText = await res.text();
      throw new Error(`HTTP ${res.status}: ${errText}`);
    }
    members = await res.json();
    banner.style.display = 'none';
    statusEl.textContent = 'â— API connected';
    statusEl.style.color = 'var(--green)';
    renderMembers();
  } catch (e) {
    console.error('loadMembers error:', e);
    document.getElementById('api-error-text').textContent = e.message;
    banner.style.display = 'block';
    statusEl.textContent = 'â— API error';
    statusEl.style.color = 'var(--red)';
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state">
      <div class="empty-icon">âš </div>
      <p style="color:var(--red)">Failed to load members â€” ${e.message}</p>
      <button class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="loadMembers()">â†» Retry</button>
    </div></td></tr>`;
  }
}

function renderMembers() {
  const q = document.getElementById('search-input').value.toLowerCase();
  let data = members;
  if (statusFilter !== 'all') data = data.filter(m => m.status === statusFilter);
  if (q) data = data.filter(m => JSON.stringify(m).toLowerCase().includes(q));
  document.getElementById('count').textContent = `Â· ${data.length} records`;
  const tbody = document.getElementById('members-tbody');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">ğŸ‘¤</div><p>No members found</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = data.map(m => `
    <tr>
      <td class="mono">${m.member_id}</td>
      <td><strong>${m.first_name} ${m.last_name}</strong></td>
      <td>${fmtDate(m.dob)}</td>
      <td>${m.email || 'â€”'}</td>
      <td class="mono">${m.phone || 'â€”'}</td>
      <td>${badge(m.status, m.status)}</td>
      <td class="mono" style="font-size:11px;color:var(--text3)">${fmtDate(m.created_at)}</td>
      <td><div class="actions">
        <button class="btn btn-sm btn-secondary" onclick="editMember('${m.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteMember('${m.id}')">Del</button>
      </div></td>
    </tr>`).join('');
}

function filterStatus(s, btn) {
  statusFilter = s;
  document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderMembers();
}

function openModal(data = null) {
  document.getElementById('save-error').style.display = 'none';
  document.getElementById('save-error').textContent = '';
  document.getElementById('modal-title').textContent = data ? 'Edit Member' : 'New Member';
  document.getElementById('f-id').value = data?.id || '';
  document.getElementById('f-member_id').value = data?.member_id || genCode('MBR');
  document.getElementById('f-first_name').value = data?.first_name || '';
  document.getElementById('f-last_name').value = data?.last_name || '';
  document.getElementById('f-dob').value = data?.dob?.split('T')[0] || '';
  document.getElementById('f-email').value = data?.email || '';
  document.getElementById('f-phone').value = data?.phone || '';
  document.getElementById('f-status').value = data?.status || 'active';
  document.getElementById('modal').classList.add('open');
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
  document.getElementById('save-error').style.display = 'none';
}

function editMember(id) { openModal(members.find(m => m.id === id)); }

async function saveMember() {
  const saveBtn = document.getElementById('save-btn');
  const errorEl = document.getElementById('save-error');

  // Validate
  const member_id = document.getElementById('f-member_id').value.trim();
  const first_name = document.getElementById('f-first_name').value.trim();
  const last_name = document.getElementById('f-last_name').value.trim();

  if (!member_id || !first_name || !last_name) {
    errorEl.textContent = 'âš  Member ID, First Name and Last Name are required.';
    errorEl.style.display = 'block';
    return;
  }

  const id = document.getElementById('f-id').value;
  const body = {
    member_id,
    first_name,
    last_name,
    dob: document.getElementById('f-dob').value || null,
    email: document.getElementById('f-email').value.trim() || null,
    phone: document.getElementById('f-phone').value.trim() || null,
    status: document.getElementById('f-status').value
  };

  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  errorEl.style.display = 'none';

  try {
    const url = id ? `/api/members/${id}` : '/api/members';
    const method = id ? 'PUT' : 'POST';
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      let errMsg = `HTTP ${res.status}`;
      try {
        const errData = await res.json();
        errMsg = errData.error || errData.message || errMsg;
      } catch {
        errMsg = await res.text() || errMsg;
      }
      throw new Error(errMsg);
    }

    await res.json();
    toast(id ? 'Member updated âœ“' : 'Member created âœ“', 'success');
    closeModal();
    loadMembers();
  } catch (e) {
    console.error('saveMember error:', e);
    errorEl.textContent = `âš  Save failed: ${e.message}`;
    errorEl.style.display = 'block';
  } finally {
    saveBtn.textContent = 'Save Member';
    saveBtn.disabled = false;
  }
}

async function deleteMember(id) {
  if (!await confirmDialog('Delete this member? This action cannot be undone.')) return;
  try {
    const res = await fetch(`/api/members/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    toast('Member deleted', 'info');
    loadMembers();
  } catch (e) {
    toast(`Delete failed: ${e.message}`, 'error');
  }
}

document.getElementById('search-input').addEventListener('input', renderMembers);
loadMembers();
</script>
</body>
</html>
