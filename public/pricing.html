<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pricing — Facets Mock</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="brand"><div class="logo"></div><div><h1>Enrollment Admin Manager</h1><p>Pricing</p></div></div>
      <nav class="nav">
        <a href="/index.html">Dashboard</a>
        <a href="/products.html">Products</a>
        <a href="/plans.html">Plans</a>
        <a href="/benefits.html">Benefits</a>
        <a class="active" href="/pricing.html">Pricing</a>
        <a href="/claims.html">Claims</a>
        <a href="/audit.html">Audit</a>
      </nav>
      <div class="footer-note">Training simulator. Not TriZetto/Facets.</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2>Fee Schedule (Allowed Amounts)</h2>
        <span class="badge">DB: SQLite</span>
      </div>

      <div class="grid">
        <section class="card">
          <h3>Add Fee Schedule Row</h3>
          <div class="form">
            <div class="full">
              <label>Plan</label>
              <select id="plan"></select>
            </div>
            <div>
              <label>Tier</label>
              <select id="tier"><option value="INN">INN</option><option value="OON">OON</option></select>
            </div>
            <div>
              <label>Code Type</label>
              <select id="ctype"><option value="CPT">CPT</option><option value="REV">REV</option></select>
            </div>
            <div>
              <label>Code Start</label>
              <input id="cs" value="99213" />
            </div>
            <div>
              <label>Code End</label>
              <input id="ce" value="99213" />
            </div>
            <div>
              <label>Allowed Amount</label>
              <input id="allowed" value="150" />
            </div>
            <div class="full">
              <button class="btn primary" id="saveBtn">Save Pricing</button>
              <div id="msg" class="footer-note"></div>
            </div>
          </div>
        </section>

        <section class="card">
          <h3>Fee Schedule Rows</h3>
          <div class="form" style="grid-template-columns:1fr 1fr">
            <div>
              <label>Filter Plan</label>
              <select id="filterPlan"></select>
            </div>
            <div>
              <label>Filter Tier</label>
              <select id="filterTier">
                <option value="">All</option>
                <option value="INN">INN</option>
                <option value="OON">OON</option>
              </select>
            </div>
          </div>

          <table class="table" id="tbl">
            <thead><tr><th>Tier</th><th>Code</th><th>Allowed</th></tr></thead>
            <tbody></tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const esc = (s)=>String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    async function api(path, opts={}){
      const res = await fetch("/api"+path,{ headers:{ "Content-Type":"application/json" }, ...opts });
      const txt = await res.text();
      let data=null; try{ data=txt?JSON.parse(txt):null; }catch{ data={ raw:txt }; }
      if(!res.ok) throw new Error(data?.error || res.statusText);
      return data;
    }
    const money = (n)=>`$${Number(n||0).toFixed(2)}`;

    async function loadPlans(){
      const plans = await api("/plans");
      const opts = plans.map(p=>`<option value="${esc(p.plan_id)}">${esc(p.plan_id)} — ${esc(p.plan_name)}</option>`).join("");
      $("#plan").innerHTML = opts;
      $("#filterPlan").innerHTML = opts;
    }

    async function loadRows(){
      const plan_id = $("#filterPlan").value;
      const tier = $("#filterTier").value;
      // If you expose GET /api/pricing?plan_id=...&tier=... then use it
      const rows = await api(`/pricing?plan_id=${encodeURIComponent(plan_id)}${tier?`&tier=${encodeURIComponent(tier)}`:""}`);

      $("#tbl tbody").innerHTML = rows.map(r=>`
        <tr>
          <td><b>${esc(r.tier)}</b></td>
          <td class="mono">${esc(r.code_type)} ${esc(r.code_start)}-${esc(r.code_end)}</td>
          <td>${money(r.allowed_amount)}</td>
        </tr>
      `).join("") || `<tr><td colspan="3" class="footer-note">No pricing rows</td></tr>`;
    }

    $("#saveBtn").addEventListener("click", async ()=>{
      $("#msg").textContent="Saving...";
      try{
        await api("/pricing",{
          method:"POST",
          body: JSON.stringify({
            plan_id: $("#plan").value,
            tier: $("#tier").value,
            code_type: $("#ctype").value,
            code_start: Number($("#cs").value),
            code_end: Number($("#ce").value),
            allowed_amount: Number($("#allowed").value)
          })
        });
        $("#msg").textContent="Saved ✅";
        await loadRows();
      }catch(e){
        $("#msg").textContent="Error: " + e.message;
      }
    });

    $("#filterPlan").addEventListener("change", ()=>loadRows().catch(()=>{}));
    $("#filterTier").addEventListener("change", ()=>loadRows().catch(()=>{}));

    (async()=>{ await loadPlans(); await loadRows(); })().catch(e=>$("#msg").textContent="Error: "+e.message);
  </script>
</body>
</html>
