<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facets ‚Äî Pricing</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">FX</div>
      <div><div class="logo-text">FACETS</div><div class="logo-sub">Config Suite</div></div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Overview</div>
      <a class="nav-item" href="index.html"><span class="nav-icon">‚óà</span> Dashboard</a>
      <div class="nav-section-label">Configuration</div>
      <a class="nav-item" href="members.html"><span class="nav-icon">üë§</span> Members</a>
      <a class="nav-item" href="products.html"><span class="nav-icon">üì¶</span> Products</a>
      <a class="nav-item" href="plans.html"><span class="nav-icon">üìã</span> Plans</a>
      <a class="nav-item" href="benefits.html"><span class="nav-icon">‚úö</span> Benefits</a>
      <a class="nav-item" href="pricing.html"><span class="nav-icon">üí≤</span> Pricing</a>
      <div class="nav-section-label">Operations</div>
      <a class="nav-item" href="claims.html"><span class="nav-icon">üìÑ</span> Claims</a>
      <a class="nav-item" href="audit.html"><span class="nav-icon">üîç</span> Audit Log</a>
    </nav>
    <div class="sidebar-footer"><div class="env-badge">Sandbox ¬∑ v1.0</div></div>
  </aside>
  <main class="main-content">
    <div class="topbar">
      <div class="topbar-left"><span class="topbar-breadcrumb">Configuration ‚Üí <span>Pricing</span></span></div>
      <div class="topbar-right"><span class="topbar-clock" id="clock"></span></div>
    </div>
    <div class="page-content">
      <div class="page-header">
        <div>
          <div class="page-title">Pricing Tiers</div>
          <div class="page-subtitle">EMPLOYER / EMPLOYEE CONTRIBUTION SPLITS</div>
        </div>
        <button class="btn btn-primary" onclick="openModal()">+ New Pricing Tier</button>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">üí≤ Pricing <span class="count-label" id="count"></span></span>
          <div class="search-bar" style="margin:0;width:260px">
            <span class="search-icon">üîé</span>
            <input type="text" placeholder="Search pricing..." id="search-input">
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead><tr>
              <th>Code</th><th>Tier</th><th>Base Premium</th><th>Employer</th><th>Employee</th><th>Effective</th><th>Split %</th><th>Status</th><th>Actions</th>
            </tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modal-title">New Pricing Tier</span>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <form class="form-grid">
        <input type="hidden" id="f-id">
        <div class="form-group">
          <label class="form-label">Pricing Code</label>
          <input type="text" class="form-input" id="f-pricing_code" required>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="f-status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-group full">
          <label class="form-label">Coverage Tier</label>
          <select class="form-select" id="f-tier">
            <option value="employee_only">Employee Only</option>
            <option value="employee_spouse">Employee + Spouse</option>
            <option value="employee_child">Employee + Child(ren)</option>
            <option value="family">Family</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Base Premium ($)</label>
          <input type="number" class="form-input" id="f-base_premium" step="0.01" min="0" oninput="calcSplit()">
        </div>
        <div class="form-group">
          <label class="form-label">Effective Date</label>
          <input type="date" class="form-input" id="f-effective_date">
        </div>
        <div class="form-group">
          <label class="form-label">Employer Contribution ($)</label>
          <input type="number" class="form-input" id="f-employer_contribution" step="0.01" min="0" oninput="calcSplit()">
        </div>
        <div class="form-group">
          <label class="form-label">Employee Contribution ($)</label>
          <input type="number" class="form-input" id="f-employee_contribution" step="0.01" min="0" oninput="calcSplit()">
        </div>
        <div class="form-group full">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:12px">
            <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-family:'IBM Plex Mono',monospace">Split Preview</div>
            <div class="progress-bar"><div class="progress-fill" id="split-bar" style="width:0%"></div></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px;font-family:'IBM Plex Mono',monospace">
              <span style="color:var(--green)">Employer: <span id="split-emp">‚Äî</span></span>
              <span style="color:var(--accent)">Employee: <span id="split-ee">‚Äî</span></span>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="save()">Save Pricing</button>
    </div>
  </div>
</div>
<script src="app.js"></script>
<script>
let records = [];

function calcSplit() {
  const base = parseFloat(document.getElementById('f-base_premium').value)||0;
  const emp = parseFloat(document.getElementById('f-employer_contribution').value)||0;
  if (!base) return;
  const pct = Math.min((emp/base)*100,100);
  document.getElementById('split-bar').style.width = pct + '%';
  document.getElementById('split-emp').textContent = pct.toFixed(0) + '%';
  document.getElementById('split-ee').textContent = (100-pct).toFixed(0) + '%';
}

async function load() {
  records = await apiFetch('/api/pricing');
  render();
}

function tierLabel(t) {
  return { employee_only:'Employee Only', employee_spouse:'Emp + Spouse', employee_child:'Emp + Child', family:'Family' }[t] || t;
}

function render() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const data = q ? records.filter(r => JSON.stringify(r).toLowerCase().includes(q)) : records;
  document.getElementById('count').textContent = `¬∑ ${data.length} records`;
  const tbody = document.getElementById('tbody');
  if (!data.length) { tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">üí≤</div><p>No pricing tiers</p></div></td></tr>`; return; }
  tbody.innerHTML = data.map(r => {
    const base = parseFloat(r.base_premium||0);
    const emp = parseFloat(r.employer_contribution||0);
    const pct = base ? Math.round((emp/base)*100) : 0;
    return `<tr>
      <td class="mono">${r.pricing_code}</td>
      <td><strong>${tierLabel(r.tier)}</strong></td>
      <td class="mono amount-billed">${currency(r.base_premium)}</td>
      <td class="mono amount-paid">${currency(r.employer_contribution)}</td>
      <td class="mono amount-allowed">${currency(r.employee_contribution)}</td>
      <td class="mono" style="font-size:11px">${fmtDate(r.effective_date)}</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <div class="progress-bar" style="width:60px"><div class="progress-fill" style="width:${pct}%"></div></div>
          <span class="mono" style="font-size:11px;color:var(--text2)">${pct}%</span>
        </div>
      </td>
      <td>${badge(r.status, r.status)}</td>
      <td><div class="actions">
        <button class="btn btn-sm btn-secondary" onclick="edit('${r.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="del('${r.id}')">Del</button>
      </div></td>
    </tr>`;
  }).join('');
}

function openModal(data = null) {
  document.getElementById('modal-title').textContent = data ? 'Edit Pricing Tier' : 'New Pricing Tier';
  document.getElementById('f-id').value = data?.id || '';
  document.getElementById('f-pricing_code').value = data?.pricing_code || genCode('PRC');
  document.getElementById('f-tier').value = data?.tier || 'employee_only';
  document.getElementById('f-base_premium').value = data?.base_premium || '';
  document.getElementById('f-employer_contribution').value = data?.employer_contribution || '';
  document.getElementById('f-employee_contribution').value = data?.employee_contribution || '';
  document.getElementById('f-effective_date').value = data?.effective_date?.split('T')[0] || '';
  document.getElementById('f-status').value = data?.status || 'active';
  document.getElementById('modal').classList.add('open');
  calcSplit();
}
function closeModal() { document.getElementById('modal').classList.remove('open'); }
function edit(id) { openModal(records.find(r => r.id === id)); }

async function save() {
  const id = document.getElementById('f-id').value;
  const body = {
    pricing_code: document.getElementById('f-pricing_code').value,
    tier: document.getElementById('f-tier').value,
    base_premium: document.getElementById('f-base_premium').value,
    employer_contribution: document.getElementById('f-employer_contribution').value,
    employee_contribution: document.getElementById('f-employee_contribution').value,
    effective_date: document.getElementById('f-effective_date').value,
    status: document.getElementById('f-status').value
  };
  if (id) { await apiFetch(`/api/pricing/${id}`, { method: 'PUT', body: JSON.stringify(body) }); toast('Pricing updated', 'success'); }
  else { await apiFetch('/api/pricing', { method: 'POST', body: JSON.stringify(body) }); toast('Pricing created', 'success'); }
  closeModal(); load();
}

async function del(id) {
  if (!await confirmDialog('Delete this pricing tier?')) return;
  await apiFetch(`/api/pricing/${id}`, { method: 'DELETE' });
  toast('Pricing deleted', 'info'); load();
}

document.getElementById('search-input').addEventListener('input', render);
load();
</script>
</body>
</html>
